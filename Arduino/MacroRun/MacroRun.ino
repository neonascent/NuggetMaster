// include the library code:
#include <LiquidCrystal.h>
#include <Servo.h>
#include <avr/pgmspace.h>

// initialize the library with the numbers of the interface pins
LiquidCrystal lcd(8, 9, 4, 5, 6, 7);

// macro from processing
int macroLines = 1280;
const char macro[1280][5] PROGMEM  = {"78a", "77a", "91s", "90s", "89q", "90q", "89w", "90w", "82z", "81z", "80z", "91x", "92x", "91s", "92s", "91s", "90s", "89s", "88s", "78a", "79a", ">", "79z", "78z", "77z", "76z", "75z", "74z", "73z", "72z", "71z", "70z", "69z", "68z", "67z", "66z", "65z", "64z", "63z", "62z", "61z", "60z", "59z", "58z", "57z", "56z", "55z", "54z", "53z", "52z", "51z", "50z", "49z", "48z", "47z", "46z", "45z", "44z", "43z", "42z", "41z", "40z", "39z", "38z", "37z", "36z", "35z", "87s", "86s", "85s", "84s", "83s", "82s", "81s", "80s", "79s", "78s", "77s", "76s", "75s", "74s", "73s", "72s", "71s", "70s", "69s", "68s", "67s", "66s", "65s", "64s", "63s", "62s", "61s", "60s", "59s", "58s", "57s", "56s", "55s", "78a", "77a", "76a", "75a", "74a", "73a", "72a", "71a", "70a", "69a", "68a", "67a", "66a", "65a", "64a", "63a", "62a", "61a", "60a", "59a", "58a", "57a", "56a", "55a", "54a", "53a", "52a", "51a", "50a", "49a", "48a", "47a", "46a", "45a", "44a", "43a", "54s", "53s", "52s", "51s", "50s", "49s", "48s", "47s", "46s", "45s", "44s", "43s", "42s", "41s", "40s", "39s", "38s", "37s", "36s", "35s", "34s", "33s", "32s", "31s", "30s", "29s", "28s", "27s", "26s", "25s", "24s", "23s", "22s", "21s", "20s", "19s", "18s", "17s", "16s", "15s", "14s", "13s", "12s", "11s", "10s", "9s", "8s", "7s", "6s", "5s", "4s", "3s", "2s", "1s", "0s", "0s", "42a", "41a", "40a", "39a", "38a", "37a", "36a", "35a", "34a", "33a", "34z", "33z", "32z", "31z", "30z", "29z", "28z", "27z", "26z", "25z", "24z", "23z", "22z", "21z", "20z", "19z", "18z", "17z", "16z", "1s", "2s", "3s", "4s", "5s", "6s", "7s", "8s", "9s", "10s", "11s", "12s", "11s", "15z", "14z", "13z", "12z", "11z", "10s", "9s", "8s", "7s", "6s", "5s", "32a", "31a", "30a", "29a", "28a", "27a", "26a", "25a", "24a", "23a", "22a", "21a", "20a", "19a", "18a", "17a", "16a", "10z", "11z", "12z", "4s", "3s", "4s", "5s", ">", "4s", "3s", "4s", "5s", "6s", "7s", "8s", "9s", "10s", "11s", "89w", "88w", "87w", "86w", "85w", "84w", "83w", "82w", "81w", "80w", "79w", "78w", "77w", "76w", "75w", "74w", "73w", "72w", "71w", "70w", "69w", "68w", "67w", "66w", "65w", "64w", "63w", "62w", "61w", "60w", "59w", "58w", "57w", "56w", "55w", "54w", "53w", "52w", "51w", "50w", "49w", "48w", "47w", "46w", "45w", "44w", "43w", "42w", "41w", "40w", "39w", "38w", "37w", "36w", "10s", "9s", "8s", "7s", "6s", "15a", "14a", "13a", "12a", "11a", "10a", "9a", "8a", "7a", "7s", "8s", "9s", "10s", "11s", "12s", "93x", "94x", "95x", "96x", "97x", "98x", "13s", "14s", "15s", "16s", "17s", "18s", "19s", "99x", "100x", "101x", "102x", "20s", "21s", "22s", "23s", "103x", "104x", "105x", "106x", "24s", "25s", "24s", "23s", "107x", "24s", ">", "37w", "38w", "39w", "40w", "41w", "42w", "43w", "44w", "45w", "46w", "47w", "48w", "49w", "50w", "51w", "52w", "53w", "54w", "55w", "56w", "57w", "58w", "59w", "60w", "61w", "62w", "63w", "64w", "65w", "66w", "67w", "68w", "69w", "70w", "71w", "72w", "73w", "74w", "75w", "76w", "106x", "105x", "104x", ">", "103x", "102x", "101x", "100x", "99x", "98x", "97x", "96x", "95x", "94x", "93x", "25s", "26s", "27s", "28s", "29s", "30s", "31s", "32s", "33s", "34s", "8a", "9a", "10a", "11a", "12a", "13z", "14z", "15z", "16z", "17z", "18z", "19z", "20z", "21z", "22z", "23z", "24z", "25z", "26z", "27z", "28z", "29z", "30z", "31z", "32z", "33z", "34z", "35z", "36z", "37z", "38z", "39z", "40z", "41z", "42z", "43z", "44z", "45z", "46z", "47z", "48z", "49z", "50z", "51z", "52z", "53z", "54z", "55z", "56z", "57z", "58z", "59z", "60z", "61z", "62z", "63z", "64z", "65z", "66z", "67z", "68z", "69z", "70z", "71z", "72z", "73z", "74z", "75z", "76z", "77z", "78z", "79z", "80z", "81z", "82z", "83z", "84z", "85z", "86z", "87z", "88z", "89z", "88z", "87z", "86z", "85z", "84z", "83z", "82z", "81z", "80z", "35s", "34s", "33s", "32s", "31s", "30s", "29s", "28s", "27s", "26s", "25s", "24s", "23s", "22s", "21s", "20s", "19s", "18s", "19s", "20s", "21s", "94x", "95x", "96x", "97x", "98x", "99x", "100x", "101x", "102x", "103x", "104x", "105x", "106x", "107x", "108x", "109x", "110x", "111x", "110x", "109x", "108x", "107x", "106x", "105x", "104x", "103x", "102x", "101x", "100x", "99x", "98x", "97x", "96x", "95x", "94x", "95x", "96x", "97x", "98x", "99x", "100x", "101x", "102x", "103x", "104x", "105x", "106x", "107x", "108x", "109x", "110x", "111x", "111x", "110x", "109x", "108x", "107x", "106x", "105x", "104x", "103x", "102x", "101x", "100x", "99x", "98x", "97x", "96x", "95x", "94x", "93x", "92x", "91x", "90x", "89x", "88x", "87x", ">", "88x", "87x", "86x", "85x", "84x", "83x", "83x", "84x", "85x", "22s", "23s", "24s", "25s", "26s", "27s", "28s", "29s", "30s", "31s", "32s", "33s", "34s", "35s", "36s", "37s", "38s", "13a", "14a", "15a", "16a", "17a", "18a", "19a", "20a", "21a", "22a", "23a", "24a", "25a", "26a", "27a", "28a", "29a", "30a", "31a", "32a", "33a", "34a", "39s", "40s", "41s", "42s", "43s", "44s", "45s", "46s", "47s", "48s", "49s", "50s", "51s", "52s", "53s", "54s", "55s", "35a", "36a", "56s", "57s", "58s", "59s", "60s", "61s", "62s", "63s", "64s", "65s", "66s", "67s", "68s", "69s", "70s", "37a", "38a", "39a", "40a", "41a", "42a", "43a", "44a", "45a", "46a", "47a", "48a", "49a", "50a", "51a", "52a", "53a", "54a", "55a", "56a", "57a", "58a", "59a", "60a", "61a", "62a", "63a", "64a", "65a", "66a", "67a", "68a", "69a", "70a", "71a", "72a", "73a", "74a", "75a", "76a", "77a", "78a", "79a", "80a", "81a", "82a", "83a", "84a", "85a", "86a", "87a", "88a", "89a", "90a", "91a", "92a", "93a", "92a", "91a", "90a", "89a", "88a", "87a", "86a", "85a", "84a", "83a", "82a", "81a", "80a", "81a", ">", "n", "81z", "82z", "83z", "84z", "85z", "86z", "87z", "88z", "89z", "90z", "91z", "92z", "93z", "94z", "95z", "96z", "97z", "98z", "99z", "100z", "101z", "102z", "103z", "104z", "105z", "106z", "107z", "108z", "109z", "110z", "111z", "112z", "113z", "114z", "115z", "116z", "117z", "118z", "119z", "120z", "121z", "122z", "123z", "124z", "125z", "126z", "127z", "128z", "129z", "130z", "131z", "132z", "133z", "134z", "135z", "136z", "137z", "138z", "139z", "140z", "141z", "142z", "143z", "144z", "145z", "146z", "147z", "148z", "149z", "150z", "151z", "152z", "153z", "154z", "155z", "156z", "157z", "158z", "159z", "160z", "161z", "162z", "163z", "164z", "165z", "80a", "69s", "68s", "79a", "67s", "78a", "77a", "76a", "86x", "87x", "88x", "75a", "74a", "73a", "72a", "71a", "70a", "69a", "68a", "67a", "66s", "65s", "64s", "63s", "62s", "61s", "60s", "59s", "58s", "57s", "56s", "55s", "54s", "53s", "52s", "51s", "50s", "49s", "48s", "47s", "46s", "45s", "44s", "43s", "42s", "41s", "40s", "39s", "38s", "37s", "36s", "35s", "34s", "33s", "32s", "31s", "30s", "31s", "30s", "29s", "28s", "75w", "74w", "73w", "72w", "71w", "70w", "69w", "68w", "67w", "66w", "64w", "62w", "60w", "58w", "56w", "54w", "52w", "50w", "48w", "47w", "46w", "45w", ">", "29s", "30s", "31s", "32s", "33s", "34s", "35s", "36s", "37s", "38s", "39s", "40s", "41s", "42s", "43s", "44s", "45s", "46s", "47s", "48s", "49s", "50s", "51s", "52s", "53s", "54s", "55s", "56s", "57s", "58s", "66a", "65a", "64a", "63a", "62a", "61a", "60a", "59a", "58a", "57a", "56a", "57a", "58a", "59a", "60a", "61a", "62a", "63a", "64a", "65a", "66a", "67a", "68a", "69a", "70a", "71a", "72a", "73a", "74a", "59s", "60s", "61s", "62s", "63s", "64s", "65s", "66s", "67s", "68s", "69s", "70s", "71s", "72s", "73s", "74s", "75s", "76s", "77s", "78s", "79s", "80s", "81s", "82s", "83s", "84s", "85s", "86s", "87s", "88s", "75a", "89s", "90s", "91s", "55w", "56w", "57w", "58w", "59w", "60w", "61w", "62w", "63w", "64w", "65w", "66w", "67w", "68w", "69w", "70w", "71w", "72w", "73w", "74w", "75w", "76w", "77w", "78w", "79w", "80w", "81w", "82w", "83w", "84w", "85w", "86w", "87w", "88w", "89w", "90w", ">", "164z", "163z", "162z", "161z", "160z", "159z", "158z", "157z", "156z", "155z", "154z", "153z", "152z", "151z", "150z", "149z", "148z", "147z", "146z", "145z", "144z", "143z", "142z", "141z", "140z", "139z", "138z", "137z", "136z", "135z", "134z", "133z", "132z", "131z", "130z", "129z", "128z", "127z", "126z", "125z", "124z", "123z", "122z", "121z", "120z", "119z", "118z", "117z", "116z", "115z", "114z", "113z", "112z", "111z", "110z", "109z", "108z", "107z", "106z", "105z", "104z", "103z", "102z", "101z", "100z", "99z", "98z", "97z", "96z", "95z", "94z", "93z", "92z", "91z", "90z", "89z", "88z", "87z", "86z", "85z", "84z", "83z", "82z", "81z", "80z", "92s", "76a", "77a", "91s", "90s", "89s", ">", ">", ">", ">", ">", ">", ">", ">", ">", ">", ">", ">", ">", ">", ">", ">", ">", ">", ">", ">", ">", "f"};

char *buffer;

const int analogInPin = A1;  // Analog input pin that the button is attached to
bool buttonPressed = false;

bool actionBlip = false;

String names[6] = {"Shoulder Twist", "Shoulder Bend", "Elbow Bend", "Wrist Angle", "Wrist Bend", "Hand Open"};
int start[6] = {90, 90, 90, 90, 90, 90};
int servoPins[6] = {1, 2, 3, 11, 12, 13};
Servo servo[6];

int relayPin = 0;

void setup() {
  //delay(1000);
  //Serial.println("M45");
  // set up the LCD's number of columns and rows:
  lcd.begin(16, 2);
  // Print a message to the LCD.
  lcd.setCursor(0, 0);
  setTitle("NuggetMaster");

  pinMode(relayPin, OUTPUT);

  // put your setup code here, to run once:
  //Serial.begin(9600);
  initialize();
}

void initialize() {
  lcd.print("Initializing");
  for (int i = 0; i < 6; i++) {
    servo[i].attach(servoPins[i]);
    servo[i].write(start[i]);
  }
  delay(200); 
}

void loop() {
  int time = 0;
  while (analogRead(analogInPin) > 500) {
    if (time > 10) {
      out("waiting");
      time = 0;
    }
    time++;
    delay(50);
  }

  // run macro
  runMacro();
  digitalWrite(relayPin, LOW);
}

void runMacro() {
  for (int i = 0; i < macroLines; i++) {
    char line[4] = {pgm_read_byte(&macro[i][0]), pgm_read_byte(&macro[i][1]), pgm_read_byte(&macro[i][2]),pgm_read_byte(&macro[i][3])};
    out(line);
    processLine(line);
    delay(30);
  }
}

void processLine(String s) {
  static int v = 0;
  for (int i = 0; i < 4; i++) {
    char ch = s[i];

    switch (ch) {
      case '0'...'9':
        v = v * 10 + ch - '0';
        break;
      case 'z':
        servoWrite(0, v);
        v = 0;
        break;
      case 'x':
        servoWrite(1, v);
        v = 0;
        break;
      case 'a':
        servoWrite(2, v);
        v = 0;
        break;
      case 's':
        servoWrite(3, v);
        v = 0;
        break;
      case 'q':
        servoWrite(4, v);
        v = 0;
        break;
      case 'w':
        servoWrite(5, v);
        v = 0;
        break;
      case 'n':
        relay(HIGH);
        break;
      case 'f':
        relay(LOW);
        break;
      case '>':
        delay(500);
        break;
      case '.':
      case '\0':
        return;
    }
  }
}

void relay(int status) {
  digitalWrite(relayPin, status);
}

void servoWrite(int s, int v) {
  servo[s].write(v);
}

void setTitle(String s) {
  lcd.setCursor(0, 0);
  lcd.print(s + "           ");
}

void setParameter(String s) {
  lcd.setCursor(12, 1);
  lcd.print(s + "   ");
}

void out(String s) {
  Serial.println(s);
  lcd.setCursor(0, 1);
  lcd.print(s);

  // action blip
  if (actionBlip) {
    lcd.print(".");
  } else {
    lcd.print(" ");
  }
  actionBlip = !actionBlip;

  for (int i = s.length(); i < 11; i++) {
    lcd.print(" ");
  }
}

